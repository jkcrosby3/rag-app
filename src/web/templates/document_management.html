{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Document Management</h2>
        <div class="d-flex gap-2">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                <i class="bi bi-cloud-upload"></i> Upload New Document
            </button>
            <button class="btn btn-outline-primary" onclick="exportSelected()">
                <i class="bi bi-download"></i> Export Selected
            </button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" class="form-control" id="searchInput" placeholder="Search documents...">
            </div>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="classificationFilter">
                <option value="">All Classifications</option>
                <option value="public">Public</option>
                <option value="internal">Internal</option>
                <option value="confidential">Confidential</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="versionFilter">
                <option value="">All Versions</option>
                <option value="latest">Latest Only</option>
                <option value="all">All Versions</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="sizeFilter">
                <option value="">All Sizes</option>
                <option value="small">< 1MB</option>
                <option value="medium">1MB - 10MB</option>
                <option value="large">> 10MB</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="uploadDateFilter">
                <option value="">All Dates</option>
                <option value="week">Last 7 Days</option>
                <option value="month">Last 30 Days</option>
                <option value="year">Last Year</option>
            </select>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll" onchange="toggleAllSelection()"></th>
                            <th>Filename</th>
                            <th>Version</th>
                            <th>Uploaded</th>	
                            <th>Size</th>
                            <th>Classification</th>
                            <th>Tags</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="documentsTable">
                        <!-- Documents will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Document</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm">
                        <div class="mb-3">
                            <label class="form-label">File</label>
                            <input type="file" class="form-control" id="uploadFile" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Classification</label>
                            <select class="form-select" id="classification" required>
                                <option value="public">Public</option>
                                <option value="internal">Internal</option>
                                <option value="confidential">Confidential</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tags</label>
                            <input type="text" class="form-control" id="tags" placeholder="Enter tags separated by commas">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="replaceVersion">
                                <label class="form-check-label" for="replaceVersion">
                                    Replace existing version if file name matches
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="uploadButton">Upload</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Metadata Edit Modal -->
    <div class="modal fade" id="metadataModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Metadata</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="metadataForm">
                        <div class="mb-3">
                            <label class="form-label">Classification</label>
                            <select class="form-select" id="editClassification" required>
                                <option value="public">Public</option>
                                <option value="internal">Internal</option>
                                <option value="confidential">Confidential</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tags</label>
                            <div class="d-flex gap-2 mb-2">
                                <div class="flex-grow-1">
                                    <input type="text" class="form-control" id="tagInput" placeholder="Type to add new tag...">
                                </div>
                                <button type="button" class="btn btn-primary" onclick="addTag()">
                                    <i class="bi bi-plus-lg"></i> Add Tag
                                </button>
                            </div>
                            <div id="tagList" class="d-flex flex-wrap gap-2 mb-3">
                                <!-- Tags will be added here dynamically -->
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="editDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Keywords</label>
                            <input type="text" class="form-control" id="editKeywords">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveMetadata">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tag Management Modal -->
    <div class="modal fade" id="tagManagementModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tag Management</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="mb-3">Create New Tag</h6>
                            <div class="mb-3">
                                <label class="form-label">Tag Name</label>
                                <input type="text" class="form-control" id="newTagName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Parent Tag</label>
                                <select class="form-select" id="newTagParent">
                                    <option value="">None</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Color</label>
                                <input type="text" class="form-control" id="newTagColor" placeholder="Hex color code">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="newTagDescription" rows="2"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Synonyms</label>
                                <div class="d-flex gap-2 mb-2">
                                    <input type="text" class="form-control" id="newSynonymInput" placeholder="Enter synonyms...">
                                    <button type="button" class="btn btn-primary" onclick="addSynonym()">
                                        <i class="bi bi-plus-lg"></i> Add Synonym
                                    </button>
                                </div>
                                <div id="synonymsList" class="d-flex flex-wrap gap-2"></div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="createTag()">
                                <i class="bi bi-plus-lg"></i> Create Tag
                            </button>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Tag Statistics</h6>
                            <div class="card">
                                <div class="card-body">
                                    <canvas id="tagUsageChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h6 class="mb-3">Tags List</h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Parent</th>
                                            <th>Color</th>
                                            <th>Description</th>
                                            <th>Usage</th>
                                            <th>Synonyms</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tagsTable">
                                        <!-- Tags will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tag Suggestion Modal -->
    <div class="modal fade" id="tagSuggestionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tag Suggestions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Document Content</label>
                        <textarea class="form-control" id="tagSuggestionText" rows="3"></textarea>
                    </div>
                    <div class="suggestions-list" id="tagSuggestions"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="applySuggestions()">Apply Selected</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let documents = [];

async function loadDocuments() {
    const filters = {
        search: document.getElementById('searchInput').value.trim(),
        classification: document.getElementById('classificationFilter').value,
        version: document.getElementById('versionFilter').value,
        size: document.getElementById('sizeFilter').value,
        uploadDate: document.getElementById('uploadDateFilter').value
    };

    const response = await fetch('/api/documents', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(filters)
    });

    if (response.ok) {
        const data = await response.json();
        documents = data;
        updateDocumentsTable();
    } else {
        alert('Failed to load documents');
    }
}

function updateDocumentsTable() {
    const tbody = document.getElementById('documentsTable');
    tbody.innerHTML = '';
    
    documents.forEach(doc => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="checkbox" class="doc-checkbox" value="${doc.id}"></td>
            <td>
                <div class="d-flex align-items-center">
                    <i class="bi bi-file-${doc.filename.split('.').pop() === 'pdf' ? 'pdf' : 'text'} me-2"></i>
                    ${doc.filename}
                </div>
            </td>
            <td>v${doc.version}</td>
            <td>${new Date(doc.uploaded_at).toLocaleString()}</td>
            <td>${(doc.size / 1024 / 1024).toFixed(1)} MB</td>
            <td><span class="badge bg-${doc.classification === 'public' ? 'success' : doc.classification === 'internal' ? 'warning' : 'danger'}">${doc.classification}</span></td>
            <td>
                <div class="d-flex gap-1">
                    ${doc.tags?.split(',').map(tag => `
                        <span class="badge bg-secondary">${tag.trim()}</span>
                    `).join('') || ''}
                </div>
            </td>
            <td>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" onclick="editMetadata('${doc.id}')">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteDocument('${doc.id}')">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

document.getElementById('uploadButton').addEventListener('click', async () => {
    const file = document.getElementById('uploadFile').files[0];
    const formData = new FormData();
    formData.append('file', file);
    formData.append('classification', document.getElementById('classification').value);
    formData.append('tags', document.getElementById('tags').value);
    formData.append('replace_version', document.getElementById('replaceVersion').checked);

    try {
        const response = await fetch('/api/documents', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            loadDocuments();
            const modal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
            modal.hide();
            document.getElementById('uploadForm').reset();
        } else {
            throw new Error('Upload failed');
        }
    } catch (error) {
        alert(error.message);
    }
});

let currentDocId = null;
let availableTags = [];

function loadTags() {
    fetch('/api/tags')
        .then(response => response.json())
        .then(data => {
            availableTags = data;
            updateTagsTable();
        });
}

function updateTagsTable() {
    const tbody = document.getElementById('tagsTable');
    tbody.innerHTML = '';
    
    // Sort tags by hierarchy
    const sortedTags = availableTags.sort((a, b) => {
        const aPath = getTagPath(a);
        const bPath = getTagPath(b);
        return aPath.localeCompare(bPath);
    });
    
    sortedTags.forEach(tag => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <span style="margin-left: ${tag.parent ? '20px' : '0'}">
                    ${tag.name}
                </span>
            </td>
            <td>${tag.parent || ''}</td>
            <td>
                <span class="badge" style="background-color: ${tag.color || '#007bff'}">
                    ${tag.name}
                </span>
            </td>
            <td>${tag.description || ''}</td>
            <td>${tag.usage_count}</td>
            <td>
                <div class="d-flex gap-2">
                    ${tag.synonyms.map(syn => `
                        <span class="badge bg-secondary">${syn.synonym}</span>
                    `).join('')}
                </div>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editTag('${tag.id}')">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteTag('${tag.id}')">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function getTagPath(tag) {
    if (!tag.parent) return tag.name;
    return getTagPath(tag.parent) + ' > ' + tag.name;
}

// Initialize tag suggestion functionality
async function initializeTagSuggestions() {
    // Load tags for the parent dropdown
    const response = await fetch('/api/tags?include_children=true');
    if (response.ok) {
        const tags = await response.json();
        const parentSelect = document.getElementById('newTagParent');
        
        // Add parent options
        tags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag.id;
            option.textContent = getTagPath(tag);
            parentSelect.appendChild(option);
        });
    }
}

// Add event listener for tag suggestion text
const tagSuggestionText = document.getElementById('tagSuggestionText');
if (tagSuggestionText) {
    tagSuggestionText.addEventListener('input', debounce(suggestTags, 500));
}

// Debounce function for rate limiting
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
}

let selectedSynonyms = new Set();

function addSynonym() {
    const synonym = document.getElementById('newSynonymInput').value.trim();
    if (synonym) {
        const element = document.createElement('span');
        element.className = 'badge bg-secondary me-2 mb-2';
        element.innerHTML = `
            ${synonym}
            <button type="button" class="btn-close btn-close-white ms-2" onclick="this.parentElement.remove(); selectedSynonyms.delete('${synonym}')"></button>
        `;
        document.getElementById('synonymsList').appendChild(element);
        selectedSynonyms.add(synonym);
        document.getElementById('newSynonymInput').value = '';
    }
}

async function applySuggestions() {
    const selectedSuggestions = document.querySelectorAll('.selected');
    const tagIds = Array.from(selectedSuggestions)
        .map(el => el.dataset.tagId);
        
    // Add these tags to the current document
    if (currentDocId) {
        try {
            const response = await fetch(`/api/documents/${currentDocId}/tags`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tag_ids: tagIds
                })
            });
            
            if (response.ok) {
                loadDocuments();
                const modal = bootstrap.Modal.getInstance(document.getElementById('tagSuggestionModal'));
                modal.hide();
            }
        } catch (error) {
            console.error(error);
        }
    }
}

// Initialize tag management when the page loads
document.addEventListener('DOMContentLoaded', () => {
    // Initialize tag suggestions
    initializeTagSuggestions();
    
    // Load tags when the management modal is shown
    const tagModal = new bootstrap.Modal(document.getElementById('tagManagementModal'));
    tagModal._element.addEventListener('show.bs.modal', () => {
        loadTags();
    });
});

function editTag(tagId) {
    const tag = availableTags.find(t => t.id === tagId);
    if (!tag) return;
    
    const modal = new bootstrap.Modal(document.getElementById('tagEditModal'));
    modal.show();
    
    document.getElementById('editTagName').value = tag.name;
    document.getElementById('editTagColor').value = tag.color || '';
    document.getElementById('editTagDescription').value = tag.description || '';
    
    document.getElementById('saveTag').onclick = async () => {
        try {
            const response = await fetch(`/api/tags/${tagId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: document.getElementById('editTagName').value,
                    color: document.getElementById('editTagColor').value,
                    description: document.getElementById('editTagDescription').value
                })
            });
            
            if (response.ok) {
                loadTags();
                modal.hide();
            } else {
                throw new Error('Update failed');
            }
        } catch (error) {
            alert(error.message);
        }
    };
}

async function deleteTag(tagId) {
    if (!confirm('Are you sure you want to delete this tag?')) return;
    
    try {
        const response = await fetch(`/api/tags/${tagId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadTags();
        } else {
            throw new Error('Delete failed');
        }
    } catch (error) {
        alert(error.message);
    }
}

function editMetadata(docId) {
    currentDocId = docId;
    const doc = documents.find(d => d.id === docId);
    
    document.getElementById('editClassification').value = doc.classification;
    document.getElementById('editDescription').value = doc.description || '';
    document.getElementById('editKeywords').value = doc.keywords || '';
    
    // Update tag list
    const tagList = document.getElementById('tagList');
    tagList.innerHTML = '';
    
    doc.tags.forEach(tag => {
        const tagElement = document.createElement('span');
        tagElement.className = 'badge bg-primary me-2';
        tagElement.innerHTML = `
            ${tag.name}
            <button type="button" class="btn-close btn-close-white ms-2" 
                    onclick="removeTagFromDocument('${docId}', '${tag.id}')"></button>
        `;
        tagList.appendChild(tagElement);
    });
    
    const modal = new bootstrap.Modal(document.getElementById('metadataModal'));
    modal.show();

    document.getElementById('saveMetadata').onclick = async () => {
        try {
            const selectedTags = Array.from(document.querySelectorAll('.tag-badge'))
                .map(tag => tag.dataset.tagId);
            
            const response = await fetch(`/api/documents/${docId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    classification: document.getElementById('editClassification').value,
                    description: document.getElementById('editDescription').value,
                    keywords: document.getElementById('editKeywords').value,
                    tag_ids: selectedTags
                })
            });
            
            if (response.ok) {
                loadDocuments();
                modal.hide();
            } else {
                throw new Error('Update failed');
            }
        } catch (error) {
            alert(error.message);
        }
    };
}

function addTag() {
    const tagName = document.getElementById('tagInput').value.trim();
    if (!tagName) return;
    
    const tag = availableTags.find(t => t.name.toLowerCase() === tagName.toLowerCase());
    if (tag) {
        addTagToDocument(tag);
    } else {
        // Create new tag and add it
        createTag().then(tag => {
            if (tag) {
                addTagToDocument(tag);
            }
        });
    }
    
    document.getElementById('tagInput').value = '';
}

function addTagToDocument(tag) {
    const tagList = document.getElementById('tagList');
    const tagElement = document.createElement('span');
    tagElement.className = 'badge bg-primary me-2';
    tagElement.dataset.tagId = tag.id;
    tagElement.innerHTML = `
        ${tag.name}
        <button type="button" class="btn-close btn-close-white ms-2" 
                onclick="removeTagFromDocument('${currentDocId}', '${tag.id}')"></button>
    `;
    tagList.appendChild(tagElement);
}

function removeTagFromDocument(docId, tagId) {
    const tagElement = document.querySelector(`[data-tag-id="${tagId}"]`);
    if (tagElement) {
        tagElement.remove();
    }
}

async function deleteDocument(docId) {
    if (!confirm('Are you sure you want to delete this document?')) return;

    try {
        const response = await fetch(`/api/documents/${docId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadDocuments();
        } else {
            throw new Error('Delete failed');
        }
    } catch (error) {
        alert(error.message);
    }
}

// Load documents when page loads
document.addEventListener('DOMContentLoaded', () => {
    loadDocuments();
    
    // Add event listeners for filters
    document.getElementById('searchInput').addEventListener('input', debounce(loadDocuments, 300));
    document.getElementById('classificationFilter').addEventListener('change', loadDocuments);
    document.getElementById('versionFilter').addEventListener('change', loadDocuments);
    document.getElementById('sizeFilter').addEventListener('change', loadDocuments);
    document.getElementById('uploadDateFilter').addEventListener('change', loadDocuments);
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function toggleAllSelection() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.doc-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
}

function exportSelected() {
    const selected = Array.from(document.querySelectorAll('.doc-checkbox:checked'))
        .map(cb => cb.value);
    
    if (selected.length === 0) {
        alert('Please select at least one document');
        return;
    }
    
    fetch('/api/documents/export', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ document_ids: selected })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Export failed');
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'documents.zip';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    })
    .catch(error => alert(error.message));
}
</script>
{% endblock %}
